親離れ／子離れ
##############

チチキトクスグカエレ
********************

SSHを用いてリモートサーバ上での作業をしていると何らかの事情で接続が切れてしまうことがあります。
接続が切れるだけなら良いのですが、長めのプロセスを起動している場合は焦ることになります。
コンソール表示が消えた上に実行中のプロセス自体が止まってしまい状況が把握できなくなるという問題が発生します。
これは親であるSSH接続のプロセスが死に際に子のプロセスに対して **シグナル** を送っていることにより発生する現象です。

過保護なシグナル
****************

シグナルの実験用にスクリプトファイルを用意します。
::

    cat << [EOF] > checkSignal.py
    #!/bin/env python
    import signal
    import datetime
    def handler(num, frame):
      with open('checkSignal.log', 'a') as f:
        f.write('%s -> %s\n' % (datetime.datetime.now().strftime('%Y/%m/%d %H:%M:%S'), num))
    for s in [1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20, 21, 23, 24, 25, 26, 27, 28, 29, 30, 31]:
      signal.signal(s, handler)
    signal.pause()
    [EOF]
    chmod 774 checkSignal.py

実行すると何らかのシグナルを受け取るまではプロンプトに制御が戻らない状態となります。
シグナルを受け取るとログファイルに日時とシグナルの番号を書き込みます。
受け取った全てのシグナルに対しての書き込みが終了するとプロセス自体も終了します。
このスクリプトでは網羅的にLinuxで発生しうるシグナルを処理するようにしています。
この他にも ``9: SIGKILL`` ``19: SIGSTOP`` のシグナルが存在しますが、プログラムでは制御できないシグナルなので省きました。
実行した状態で ``Ctrl + z`` を指示すると ``2: SIGINT`` が送られていることが判ります。
また実行した状態で故意に接続を切ると ``1: SIGHUP`` が送られていることが判り、これが親離れできない原因だと判ります。

個室を用意する
**************

screen
======

親しき中にも礼儀ありです。
screenを利用して親の目が届かない状態にします。
screenは画面管理のソフトウェアであり本来は多機能なのですが、今回の問題解決だけを意識した場合は非常にシンプルです。

インストールする
----------------
::

    yum -y install screen

OSに付随するパッケージ管理ソフトでインストールしましょう。

セッションを作る
----------------
::

    screen -S maeda

セッションとは１つひとつが独立した個室のようなものです。
``-S`` オプションで任意の名前（この例ではmaeda）を付けます。
必ずしも名前を付ける必要はありませんが付けておいた方が無難です。

セッションに出入りする
----------------------
::

    # 名前を指定してセッションに入る
    screen -r maeda

    # 現在のセッションから出る
    Ctrl + a + d

セッションは作った段階で入っている状態ですが外から入る方法も覚えましょう。
現在のセッションから出る場合はプロンプトに制御がない状態を想定してコントロールを押しながらの操作となります。
シグナル実験用のスクリプトを用いると ``1: SIGHUP`` が発生しなくなったことが確認できます。

セッションを片付ける
--------------------
::

    # 全てのセッションを表示する
    screen -ls

    # 現在のセッションを消す
    Ctrl + t + d

セッションは放置すれば増え続けます。確認して消す習慣をつけましょう。
なお **消す操作と出る操作は似ている** ため注意が必要です。
``t`` はterminate（終了）であり危険であるという意識が必要です。
screenを扱うために必須となる操作はこれだけです。
手が自然に動くぐらいに練習しておきましょう。
